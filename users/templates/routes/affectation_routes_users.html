{% load static %}
{% load widget_tweaks %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Assign route-client</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

    <style>
        .navbar {
            background-color: #f8f9fa;
        }

        .navbar-brand {
            font-weight: bold;
        }

        .navbar-nav .nav-link {
            color: #007bff;
        }

        .btn-primary {
            background-color: #81bae7;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            align-self: center;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .form-inline .form-control {
            width: auto;
        }

        .auto-width-select {
            width: auto;
            min-width: 150px;
            max-width: 100%;
            white-space: nowrap;
        }

        h1, h2 {
            color: #0056b3;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 200%;
            text-align: center;
        }

        .btn-sm {
            padding: 5px 10px;
        }

        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }

        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }

        .btn-warning {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background-color: #e0a800;
            border-color: #d39e00;
            color: #212529;
        }

        .mt-4 {
            margin-top: 1.5rem;
        }

        .float-right {
            float: right;
        }

        .table {
            --bs-table-bg: none;
        }

        th {
            background-color: #2262c6;
            color: #fff;
        }
        thead {
            background-color: #2262c6;
            color: #fff;
        }
        .clients-container {
            display: flex;
            flex-wrap: wrap;
        }

        .section {
            flex: 1;
            padding: 20px;
            border-right: 1px solid #ccc;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }

        .section:last-child {
            border-right: none;
        }

        .table-responsive {
            overflow-x: auto;
        }
        .center-container {
            display: flex;
            justify-content: center;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">
        <img src="{% static 'images/download.jpeg' %}" alt="Logo" style="width: 200px; height: 60px;">
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
            <li class="nav-item">
                <a class="nav-link text-dark" href="{% url 'home' %}">Home</a>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle text-dark" data-bs-toggle="dropdown" href="#" aria-expanded="false">Users</a>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{% url 'users' %}">Info Users</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{% url 'home_groupe' %}">User Groupe</a></li>
                </ul>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle text-dark" data-bs-toggle="dropdown" href="#" aria-expanded="false">Clients</a>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{% url 'home_client' %}">Info Client</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{% url 'home_client_status' %}">Statut des Client</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{% url 'home_target' %}">Client target</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{% url 'home_discounts' %}">Client discount</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{% url 'home_channel' %}">Channels</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a class="nav-link text-dark" href="{% url 'devices' %}">Devices</a>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle text-dark" data-bs-toggle="dropdown" href="#" aria-expanded="false">Routes</a>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{% url 'routes' %}">Routes</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{% url 'affectation_routes_users' %}">Affectation Routes-Users</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{% url 'affectation_clients_routes' %}">Affectation Routes-Clients</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a class="nav-link text-dark" href="{% url 'promotions' %}">Promotion</a>
            </li>
            <li class="nav-item">
                <a class="nav-link text-dark" href="{% url 'login' %}">Login</a>
            </li>
        </ul>
    </div>
</nav>

<!-- ------------------------------------------------------------------------------------------------------- -->
<body>
    <h2>Route Assignment</h2>



<div class="d-flex justify-content-center">
    <div class="form-container">
        <div aria-hidden="true" id="userSelection">
            <label for="users"></label>
            <select id="users" name="users" onchange="loadUserRoutes(this.value)">
                <option value="">Select a user</option>
                {% for user in users %}
                    <option value="{{ user.UserCode }}">{{ user.UserName }}</option>
                {% endfor %}
            </select>
            
            <button id="findUsers" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#userListModal" onclick="findUsers()">Find</button>
        </div>
    </div>
</div>


<div class="container mt-4">
    <!-- USERS container -->
    <div id="routesContainer"  class="clients-container" style="display: none;">
        <div class="section table-responsive" id="availableRoutesSection">
            <h3>Available Routes</h3>
            <table id="availableRoutes" class="table table-striped">
                <thead>
                    <tr>
                        <th>user code</th>
                        <th>user Description</th>
                        <th>city code</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Available clients will be dynamically inserted here -->
                </tbody>
            </table>
        </div>

        <!-- Separator -->
        <div class="section-separator"></div>

        <div class="section table-responsive" id="userRoutesSection">
            <h3>Assigned Route</h3>
            <table id="userRoutes" class="table table-striped">
                <thead>
                    <tr>
                        <th>Route code</th>
                        <th>user Description</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Assigned clients will be dynamically inserted here -->
                </tbody>
            </table>
        </div>
    </div>
</div>


<div class="modal fade" id="userListModal" tabindex="-1" role="dialog" aria-labelledby="userListModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userListModalLabel">Select a User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-bordered" id="userListTable">
                    <thead>
                        <tr>
                            <th>UserCode</th>
                            <th>UserName</th>
                            <th>CityID</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="userList">
                        <!-- User list will be dynamically populated here -->
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<script>
        // Function to fetch and display user list in a table
        function findUsers() {
            $.ajax({
                url: "{% url 'get_users' %}",
                method: 'GET',
                success: function(data) {
                if (data.users) {    
                    $('#userList').empty(); // Clear any existing rows
                    data.users.forEach(function(user) {
                        $('#userList').append(
                            '<tr>' +
                            '<td>' + user.UserCode + '</td>' +
                            '<td>' + user.UserName + '</td>' +
                            '<td>' + user.CityID + '</td>' +
                            '<td><button onclick="selectUser(\'' + user.UserCode + '\', \'' + user.UserName + '\', \'' + user.CityID + '\')">Select</button></td>' +
                            '</tr>'
                        );
                    });
                    $('#userListModal').modal('show');
                } else {
                    alert('No routes found');
                }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to fetch users:', error);
                    alert('Failed to fetch users: ' + error);
                }
            });
        }

        // Function to handle the selection of a user
        function selectUser(userCode, userName, CityID) {
            $('#users').val(userCode).change();
            $('#userListModal').modal('hide');
        }

        // Function to load user routes based on selected user
        function loadUserRoutes(userId) {
            if (userId) {
                $.ajax({
                    url: "{% url 'affectation_routes_users' %}",
                    method: 'GET',
                    data: { action: 'get_user_routes', user_code: userId },
                    success: function(data) {
                        
                        $('#availableRoutes').empty();
                            $('#availableRoutes').append(
                                '<thead style="background-color:#2262c6; color: #fff;">' +
                                    '<tr>' +
                                        '<th>Route ID</th>' +
                                        '<th>Route Description</th>' +
                                        '<th>Action</th>' +
                                    '</tr>' +
                                '</thead>' +
                                '<tbody></tbody>' // Ensure there's a tbody to append rows
                            );
                         $('#userRoutes').empty();    
                            $('#userRoutes').append(
                                '<thead style="background-color:#2262c6; color: #fff;">' +
                                    '<tr>' +
                                        '<th>Route ID </th>' +
                                        '<th>Route Description</th>' +
                                        '<th>Action</th>' +
                                    '</tr>' +
                                '</thead>' +
                                '<tbody></tbody>'  // Ensure there's a tbody to append rows
                            );

  
                        data.unlinked_routes.forEach(function(route) {
                            $('#availableRoutes').append(
                                '<tr>' +
                                '<td>' + route.Route_ID + '</td>' +
                                '<td>' + route.Route_Description + '</td>' +
                                '<td><button class="btn btn-primary" onclick="assignRoute(\'' + route.Route_ID + '\')">Assign</button></td>' +
                            '</tr>'
                            );
                        });

                        
                        if (data.linked_routes.length > 0) {
                            const route = data.linked_routes[0];
                            $('#userRoutes').append(
                                '<tr>' +
                                '<td>' + route.Route_ID + '</td>' +
                                '<td>' + route.Route_Description + '</td>' +
                                '<td><button class="btn btn-primary" onclick="removeRoute(\'' + route.Route_ID + '\')">Remove</button></td>' +
                            '</tr>'
                            );
                        }
                        $('#routesContainer').show();
                        
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to fetch user routes:', error);
                        alert('Failed to fetch user routes: ' + error);
                    },
                    
                });
            } else {
                $('#routesContainer').hide();
            }
        }

        // Assign the selected route to the user
            function assignRoute(routeID) {
                
                var userId = $('#users').val();
                if (routeID && userId) {
                    $.ajax({
                        url: "{% url 'assign_user_to_route' %}",
                        type: 'POST',
                        data: {
                            route_id: routeID,
                            user_code: userId,
                            action: 'assign',
                            csrfmiddlewaretoken: '{{ csrf_token }}'
                            

                        },
                        success: function(data) {
                            if (data.success) {
                                alert('Route assigned successfully');
                                loadUserRoutes(userId); // Reload routes to reflect changes
                            } else {
                                alert('Failed to assign route: ' + data.error);
                            }
                        },
                        error: function(xhr, status, error) {
                            alert('Failed to assign route: ' + error);
                        }
                    });
                } else {
                    console.log('User ID:', userId);
                    console.log('Route ID:', routeId);
                    alert('Please select a user and a route');
                }
            }

        // Remove the user's route
        function removeRoute(routeId) {
            
            var userId = $('#users').val();
            if (userId && routeId) {
                $.ajax({
                    url: "{% url 'assign_user_to_route' %}",
                    type: 'POST',
                    data: {
                        route_id: routeId,
                        user_code: userId,
                        action: 'remove',
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function(data) {
                        if (data.success) {
                            alert('Route removed successfully');
                            loadUserRoutes(userId); // Reload routes to reflect changes
                        } else {
                            alert('Failed to remove route: ' + data.error);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Failed to remove route: ' + error);
                    }
                });
            } else {
                alert('Invalid user or route');
            }
        }
    </script>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
